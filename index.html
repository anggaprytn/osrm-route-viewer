<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Polyline Viewer with Start/End Marker</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      textarea {
        width: 100%;
        height: 200px;
      }
      #map {
        height: 500px;
        margin-top: 10px;
      }
      button {
        margin-top: 10px;
        padding: 6px 12px;
      }
    </style>
  </head>
  <body>
    <h2>Route Viewer (from OSRM JSON)</h2>
    <textarea id="jsonInput" placeholder="Paste OSRM JSON here..."></textarea>
    <br />
    <button onclick="renderRoute()">Render Route</button>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Polyline decoder
      function decodePolyline(str, precision = 5) {
        let index = 0,
          lat = 0,
          lng = 0,
          coordinates = [];
        const factor = Math.pow(10, precision);

        while (index < str.length) {
          let result = 0,
            shift = 0,
            byte;
          do {
            byte = str.charCodeAt(index++) - 63;
            result |= (byte & 0x1f) << shift;
            shift += 5;
          } while (byte >= 0x20);
          const deltaLat = result & 1 ? ~(result >> 1) : result >> 1;
          lat += deltaLat;

          result = 0;
          shift = 0;
          do {
            byte = str.charCodeAt(index++) - 63;
            result |= (byte & 0x1f) << shift;
            shift += 5;
          } while (byte >= 0x20);
          const deltaLng = result & 1 ? ~(result >> 1) : result >> 1;
          lng += deltaLng;

          coordinates.push([lat / factor, lng / factor]);
        }
        return coordinates;
      }

      const map = L.map("map").setView([-6.2, 106.8], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      let polylineLayer = null;
      let startMarker = null;
      let endMarker = null;

      function renderRoute() {
        const raw = document.getElementById("jsonInput").value.trim();
        if (!raw) return alert("Please paste JSON input.");

        let data;
        try {
          data = JSON.parse(raw);
        } catch (e) {
          alert("Invalid JSON: " + e.message);
          console.error("JSON parsing error:", e);
          return;
        }

        const geometry = data.routes?.[0]?.geometry;
        const waypoints = data.waypoints;
        if (!geometry || !waypoints || waypoints.length < 2) {
          alert("Invalid OSRM JSON format.");
          return;
        }

        const coords = decodePolyline(geometry);

        if (polylineLayer) map.removeLayer(polylineLayer);
        if (startMarker) map.removeLayer(startMarker);
        if (endMarker) map.removeLayer(endMarker);

        polylineLayer = L.polyline(coords, { color: "blue" }).addTo(map);
        map.fitBounds(polylineLayer.getBounds());

        const [startLng, startLat] = waypoints[0].location;
        const [endLng, endLat] = waypoints[1].location;

        startMarker = L.marker([startLat, startLng])
          .addTo(map)
          .bindPopup(`Start Point<br/>Lat: ${startLat}<br/>Lng: ${startLng}`)
          .openPopup();

        endMarker = L.marker([endLat, endLng])
          .addTo(map)
          .bindPopup(`End Point<br/>Lat: ${endLat}<br/>Lng: ${endLng}`);
      }
    </script>
  </body>
</html>
